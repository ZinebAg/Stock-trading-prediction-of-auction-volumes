# -*- coding: utf-8 -*-
# """MixedModel_secondTrial.ipynb

# Automatically generated by Colaboratory.

# Original file is located at
#     https://colab.research.google.com/drive/1XX7DkleB67yWY-EvmY-jQEho8ncNpoy5
# """

# Commented out IPython magic to ensure Python compatibility.
#  %load_ext rpy2.ipython

# from google.colab import drive
# drive.mount('/content/drive')

# %%R
install.packages("refund") # takes just under 10 minutes

# %%R
install.packages("tidymv")

# Commented out IPython magic to ensure Python compatibility.
# %%R
install.packages(c("readr", "data.table", "lme4", "dplyr","lattice", "visreg", "ggeffects", "zoo")) # takes a bit less than 3 minutes
#

# Commented out IPython magic to ensure Python compatibility.
# %%R
install.packages("MLmetrics")

# Commented out IPython magic to ensure Python compatibility.
# %%R
install.packages('jtools')

# Commented out IPython magic to ensure Python compatibility.
# %%R
# install.packages('R.utils')

# Commented out IPython magic to ensure Python compatibility.
# %%R
library(readr)
library(data.table)
library(lme4)
library(jtools)
library(dplyr)
library(ggeffects)
library(lattice)
library(zoo)
library(MLmetrics)
library(R.utils)

# %%R
# loading the data
target <- read_csv("/content/drive/MyDrive/Master Semester Project/data/output_training_IxKGwDV.csv")
train <- fread("/content/drive/MyDrive/Master Semester Project/data/data_RF_KNN_2.csv.gz")
train$target <- target$target
test<-fread("/content/drive/MyDrive/Master Semester Project/data/test_RF_KNN_2.csv.gz")

#names(train) = gsub(pattern = "_", replacement = "", x = names(train))

test<-fread("/content/drive/MyDrive/Master Semester Project/data/test_RF_KNN_2.csv.gz")

# %%R
# trying first without using all the columns

Model_0<- lmer(target ~ NLV + LS + (1|pid)+ (1|day), data = train)
summary(Model_0)

# %%R
# saving the model
saveRDS(Model_0, file = "/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_0.rda")

Commented out IPython magic to ensure Python compatibility.
%%R
#loading the model
Model_0 = readRDS("/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_0.rda")
# Model_0

%%R
#do predictions
#test<-na.aggregate(test)

train_predicted <- predict(Model_0, train[,-1])
MSE(train_predicted, train$target) # 0.3187642

%%R
# writing the formula
formula_relvol<- paste("rel_vol", 0:60, sep="")
formula_absret<- paste("abs_ret", 0:60, sep="")
formula_all <- as.formula(paste("target ~ NLV + LS + (1|pid)+ (1|day)+", paste(c(formula_relvol, formula_absret), collapse= "+")))
# writing the formula
formula_abs <- as.formula(paste("target ~ NLV + LS + (1|pid)+ (1|day)+", paste(c(formula_absret), collapse= "+")))
# writing the formula
formula_relvol <- as.formula(paste("target ~ NLV + LS + (1|pid)+ (1|day)+", paste(c(formula_relvol), collapse= "+")))

#%%R
Model_1<- lmer(formula_all, data = train)
summary(Model_1)

#%%R
# saving the model
saveRDS(Model_1, file = "/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_1.rda")

#Commented out IPython magic to ensure Python compatibility.
#%%R
#loading the model
Model_1 = readRDS("/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_1.rda")
# Model_1

#%%R
#do predictions
#test<-na.aggregate(test)

train_predicted_1 <- predict(Model_1, train[,-1])
MSE(train_predicted_1, train$target) # 0.3151599

#%%R
Model_full<- lmer(formula_all, data = train)
summary(Model_full)

#%%R
# saving the model
saveRDS(Model_full, file = "/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_full.rda")

Commented out IPython magic to ensure Python compatibility.
#%%R
#loading the model
Model_full = readRDS("/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_full.rda")
# Model_full

#%%R
train_predicted_full <- predict(Model_full, train[,-1])
MSE(train_predicted_full, train$target) #0.3151599

#%%R
Model_abs<- lmer(formula_abs, data = train)
summary(Model_abs)

#%%R
# saving the model
saveRDS(Model_abs, file = "/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_abs.rda")

Commented out IPython magic to ensure Python compatibility.
#%%R
#loading the model
Model_abs = readRDS("/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_abs.rda")
# Model_abs

#%%R
train_predicted_abs <- predict(Model_abs, train[,-1])
MSE(train_predicted_abs, train$target) # 0.3162477

#%%R
Model_rel<- lmer(formula_relvol, data = train)
summary(Model_rel)



#%%R
# saving the model
saveRDS(Model_rel, file = "/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_rel.rda")

Commented out IPython magic to ensure Python compatibility.
#%%R
#loading the model
Model_rel = readRDS("/content/drive/MyDrive/Master Semester Project/notebooks/Week12/model_rel.rda")
# Model_rel

#%%R
train_predicted_rel <- predict(Model_abs, train[,-1])
MSE(train_predicted_rel, train$target) # 0.3162477

Commented out IPython magic to ensure Python compatibility.
#%%R
# anova(Model_full,Model_0)

#%%R
anova(Model_full,Model_rel)

#%%R
anova(Model_rel,Model_0)

#%%R
anova(Model_full,Model_abs)

Commented out IPython magic to ensure Python compatibility.
#%%R
anova(Model_abs,Model_0)